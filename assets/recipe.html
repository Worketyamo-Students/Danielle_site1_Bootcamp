<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
    <link rel="icon" href="./img/logo.png" type="image/x-icon">
    <link rel="stylesheet" href="./css/index.css">
    <title>TchopIA - Recette</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <style type="text/tailwindcss">
        @theme {
            --color-bouton:#BA5E0D;
            --font-inter:"Inter", sans-serif;
        }
    </style>
    
    <style>
        /* Loading animation */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .animate-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        
        .animate-spin {
            animation: spin 1s linear infinite;
        }
        
        /* Recipe content styling */
        .recipe-content {
            line-height: 1.8;
        }
        
        .recipe-content h1, .recipe-content h2, .recipe-content h3 {
            color: #BA5E0D;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
        }
        
        .recipe-content ul, .recipe-content ol {
            margin: 1rem 0;
            padding-left: 1.5rem;
        }
        
        .recipe-content li {
            margin: 0.5rem 0;
        }
        
        /* Print styles */
        @media print {
            .no-print {
                display: none !important;
            }
            
            .recipe-content {
                font-size: 12pt;
                line-height: 1.6;
            }
        }
        
        /* Mobile responsiveness */
        @media (max-width: 768px) {
            .recipe-actions {
                flex-direction: column;
                gap: 0.75rem;
            }
            
            .recipe-actions button {
                width: 100%;
            }
        }
    </style>
</head>

<body class="bg-gray-50 min-h-screen">
    <header class="w-full p-3 sm:p-4 md:p-6 bg-white shadow-sm no-print">
        <div class="flex items-center justify-between">
            <div class="flex items-center">
                <img src="./img/logo ia.jpg" alt="logo TchopIA" class="w-6 h-6 sm:w-8 sm:h-8 rounded mr-2">
                <p class="font-semibold text-[18px] sm:text-[20px] md:text-[24px] font-inter">TchopIA</p>
            </div>
            
            <!-- Mobile menu button -->
            <button id="mobile-menu-btn" class="sm:hidden">
                <ion-icon name="menu" class="text-[24px]"></ion-icon>
            </button>
            
            <!-- Desktop navigation -->
            <nav class="hidden sm:flex items-center space-x-4 md:space-x-6">
                <a href="../index.html" class="text-[14px] md:text-[16px] hover:underline hover:text-bouton font-inter transition-colors duration-200">Accueil</a>
                <a href="./ia.html" class="text-[14px] md:text-[16px] hover:underline hover:text-bouton font-inter transition-colors duration-200">Assistant IA</a>
                <a href="./contact.html" class="text-[14px] md:text-[16px] hover:underline hover:text-bouton font-inter transition-colors duration-200">Contact</a>
            </nav>
            
            <!-- Mobile navigation menu (hidden by default) -->
            <nav id="mobile-menu" class="hidden sm:hidden absolute top-full left-0 w-full bg-white shadow-lg z-50">
                <div class="flex flex-col p-4 space-y-3">
                    <a href="../index.html" class="text-[16px] hover:text-bouton font-inter transition-colors duration-200">Accueil</a>
                    <a href="./ia.html" class="text-[16px] hover:text-bouton font-inter transition-colors duration-200">Assistant IA</a>
                    <a href="./contact.html" class="text-[16px] hover:text-bouton font-inter transition-colors duration-200">Contact</a>
                </div>
            </nav>
        </div>
    </header>

    <main class="max-w-4xl mx-auto px-4 sm:px-6 md:px-8 py-6">
        <!-- Back Button -->
        <div class="mb-4 no-print">
            <button onclick="goBack()" class="inline-flex items-center text-bouton hover:text-orange-700 transition-colors duration-200">
                <ion-icon name="arrow-back-sharp" class="mr-2"></ion-icon>
                <span class="text-[14px] sm:text-[16px]">Retour</span>
            </button>
        </div>

        <!-- Loading State -->
        <div id="loading-state" class="text-center py-16">
            <div class="animate-spin rounded-full h-16 w-16 border-b-4 border-bouton mx-auto mb-6"></div>
            <h2 class="font-inter font-semibold text-[24px] sm:text-[28px] text-bouton mb-4">
                üë©‚Äçüç≥ TchopIA pr√©pare votre recette...
            </h2>
            <p class="text-gray-600 font-inter text-[16px] animate-pulse" id="loading-message">
                G√©n√©ration de la recette en cours
            </p>
        </div>

        <!-- Error State -->
        <div id="error-state" class="hidden text-center py-16">
            <div class="bg-red-50 border border-red-200 rounded-lg p-8">
                <ion-icon name="alert-circle" class="text-red-500 text-6xl mb-4"></ion-icon>
                <h2 class="font-inter font-semibold text-[24px] text-red-700 mb-4">
                    Erreur de g√©n√©ration
                </h2>
                <p class="text-red-600 font-inter text-[16px] mb-6" id="error-message">
                    Une erreur s'est produite lors de la g√©n√©ration de la recette.
                </p>
                <div class="flex flex-col sm:flex-row gap-3 justify-center">
                    <button onclick="retryRecipe()" class="bg-red-600 text-white px-6 py-2 rounded-lg hover:bg-red-700 transition-colors">
                        üîÑ R√©essayer
                    </button>
                    <button onclick="goBack()" class="bg-gray-600 text-white px-6 py-2 rounded-lg hover:bg-gray-700 transition-colors">
                        ‚¨ÖÔ∏è Retour
                    </button>
                </div>
            </div>
        </div>

        <!-- Recipe Display -->
        <div id="recipe-display" class="hidden">
            <!-- Recipe Header -->
            <div class="bg-white rounded-lg shadow-lg p-6 mb-6 border-l-4 border-bouton">
                <div class="flex items-center justify-between mb-4 no-print">
                    <div class="flex items-center">
                        <img src="./img/logo ia.jpg" alt="TchopIA" class="w-10 h-10 rounded-full mr-4">
                        <div>
                            <h1 class="font-inter font-bold text-[24px] sm:text-[28px] md:text-[32px] text-bouton" id="recipe-title">
                                Recette TchopIA
                            </h1>
                            <p class="text-gray-600 text-sm" id="recipe-metadata">
                                G√©n√©r√©e par l'IA ‚Ä¢ <span id="generation-time"></span>
                            </p>
                        </div>
                    </div>
                    <div class="hidden sm:block text-right">
                        <div class="text-xs text-gray-500" id="parse-info">
                            <!-- Parse info will be inserted here -->
                        </div>
                    </div>
                </div>
                
                <!-- Recipe Content -->
                <div id="recipe-content" class="recipe-content font-inter">
                    <!-- Recipe content will be inserted here -->
                </div>
            </div>
            
            <!-- Recipe Actions -->
            <div class="recipe-actions flex flex-wrap gap-3 justify-center no-print">
                <button onclick="saveRecipe()" class="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition-colors flex items-center">
                    <ion-icon name="download-outline" class="mr-2"></ion-icon>
                    üíæ Sauvegarder
                </button>
                <button onclick="shareRecipe()" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors flex items-center">
                    <ion-icon name="share-outline" class="mr-2"></ion-icon>
                    üì§ Partager
                </button>
                <button onclick="printRecipe()" class="bg-purple-600 text-white px-6 py-3 rounded-lg hover:bg-purple-700 transition-colors flex items-center">
                    <ion-icon name="print-outline" class="mr-2"></ion-icon>
                    üñ®Ô∏è Imprimer
                </button>
                <button onclick="generateNewRecipe()" class="bg-orange-600 text-white px-6 py-3 rounded-lg hover:bg-orange-700 transition-colors flex items-center">
                    <ion-icon name="refresh-outline" class="mr-2"></ion-icon>
                    üîÑ Nouvelle version
                </button>
                <button onclick="goBack()" class="bg-gray-600 text-white px-6 py-3 rounded-lg hover:bg-gray-700 transition-colors flex items-center">
                    <ion-icon name="arrow-back-outline" class="mr-2"></ion-icon>
                    ‚¨ÖÔ∏è Retour
                </button>
            </div>
        </div>
    </main>

    <script>
        // Configuration
        const N8N_WEBHOOK_URL = 'http://localhost:5678/webhook/tchopia-ai';
        
        // Current recipe data
        let currentRecipeData = {
            name: '',
            description: '',
            content: '',
            metadata: {}
        };

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            initializePage();
            setupMobileMenu();
            updateLoadingMessages();
        });

        function initializePage() {
            // Get recipe parameters from URL
            const urlParams = new URLSearchParams(window.location.search);
            const recipeName = urlParams.get('name');
            const recipeDescription = urlParams.get('description');
            
            console.log('Recipe page initialized with:', { recipeName, recipeDescription });
            
            if (recipeName) {
                currentRecipeData.name = decodeURIComponent(recipeName);
                currentRecipeData.description = decodeURIComponent(recipeDescription || '');
                
                // Start recipe generation
                generateRecipe(currentRecipeData.name, currentRecipeData.description);
            } else {
                showError('Aucune recette sp√©cifi√©e. Veuillez retourner √† la page pr√©c√©dente.');
            }
        }

        function updateLoadingMessages() {
            const messages = [
                'Analyse des ingr√©dients traditionnels...',
                'Recherche des techniques de cuisson...',
                'Pr√©paration des instructions d√©taill√©es...',
                'Ajout des conseils de grand-m√®re...',
                'Finalisation de votre recette...'
            ];
            
            let messageIndex = 0;
            const messageElement = document.getElementById('loading-message');
            
            const interval = setInterval(() => {
                if (document.getElementById('loading-state').classList.contains('hidden')) {
                    clearInterval(interval);
                    return;
                }
                
                messageElement.textContent = messages[messageIndex];
                messageIndex = (messageIndex + 1) % messages.length;
            }, 2000);
        }

        async function generateRecipe(recipeName, recipeDescription = '') {
            try {
                showLoading();
                
                console.log('Generating recipe for:', { recipeName, recipeDescription });
                
                const response = await fetch(N8N_WEBHOOK_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        recipe_name: recipeName,
                        recipe_description: recipeDescription,
                        action: 'generate_recipe',
                        context: `G√©n√©rez une recette d√©taill√©e pour "${recipeName}". ${recipeDescription ? `Description: ${recipeDescription}` : ''} Incluez les ingr√©dients, les √©tapes de pr√©paration, le temps de cuisson, et des conseils traditionnels.`
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log('Recipe response from n8n:', data);
                
                // Handle enhanced workflow response format
                let recipeContent = null;
                let responseData = null;
                
                // Check if response is an array (enhanced workflow format)
                if (Array.isArray(data) && data.length > 0) {
                    responseData = data[0];
                    
                    // Look for recipe content in different possible fields
                    if (responseData.parsedResponse && responseData.parsedResponse.content) {
                        recipeContent = responseData.parsedResponse.content;
                    } else if (responseData.rawResponse) {
                        recipeContent = responseData.rawResponse;
                    }
                }
                // Fallback: check for direct recipe property (old format)
                else if (data.recipe) {
                    recipeContent = data.recipe;
                    responseData = data;
                }
                // Additional fallback: check for content directly
                else if (data.content) {
                    recipeContent = data.content;
                    responseData = data;
                }
                
                if (recipeContent) {
                    currentRecipeData.content = recipeContent;
                    currentRecipeData.metadata = {
                        success: responseData.success || true,
                        timestamp: responseData.timestamp || new Date().toISOString(),
                        parseInfo: responseData.parseInfo || null,
                        action: responseData.action || 'generate_recipe'
                    };
                    
                    displayRecipe(recipeName, recipeContent, responseData);
                } else {
                    console.error('No recipe content found in response:', data);
                    showError('Erreur lors de la g√©n√©ration de la recette. Aucun contenu re√ßu.');
                }
                
            } catch (error) {
                console.error('Error generating recipe:', error);
                showError('Erreur de connexion. V√©rifiez que votre serveur n8n est en cours d\'ex√©cution.');
            }
        }

        function showLoading() {
            document.getElementById('loading-state').classList.remove('hidden');
            document.getElementById('error-state').classList.add('hidden');
            document.getElementById('recipe-display').classList.add('hidden');
        }

        function showError(message) {
            document.getElementById('error-message').textContent = message;
            document.getElementById('loading-state').classList.add('hidden');
            document.getElementById('error-state').classList.remove('hidden');
            document.getElementById('recipe-display').classList.add('hidden');
        }

        function displayRecipe(recipeName, recipeContent, responseData = null) {
            const recipeDisplay = document.getElementById('recipe-display');
            const recipeTitle = document.getElementById('recipe-title');
            const recipeContentDiv = document.getElementById('recipe-content');
            const generationTime = document.getElementById('generation-time');
            const parseInfo = document.getElementById('parse-info');
            
            // Set title
            recipeTitle.textContent = recipeName;
            
            // Set generation time
            generationTime.textContent = new Date().toLocaleString('fr-FR');
            
            // Set parse info
            if (responseData && responseData.parseInfo) {
                parseInfo.innerHTML = `
                    <span class="text-green-600">‚úÖ Analys√© avec ${responseData.parseInfo.method}</span>
                `;
            }
            
            // Format the recipe content for better display
            let formattedContent = recipeContent;
            
            // If we have structured recipe data, format it nicely
            if (responseData && responseData.parsedResponse) {
                const parsed = responseData.parsedResponse;
                
                if (parsed.title || parsed.ingredients || parsed.instructions) {
                    formattedContent = '';
                    
                    if (parsed.cookingTime) {
                        formattedContent += `
                            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center">
                                        <ion-icon name="time-outline" class="text-blue-600 mr-2"></ion-icon>
                                        <span class="font-semibold text-blue-800">‚è±Ô∏è Temps de cuisson:</span>
                                    </div>
                                    <span class="text-blue-700 font-medium">${parsed.cookingTime}</span>
                                </div>
                                ${parsed.servings ? `
                                    <div class="flex items-center justify-between mt-2">
                                        <div class="flex items-center">
                                            <ion-icon name="people-outline" class="text-blue-600 mr-2"></ion-icon>
                                            <span class="font-semibold text-blue-800">üë• Portions:</span>
                                        </div>
                                        <span class="text-blue-700 font-medium">${parsed.servings}</span>
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    }
                    
                    if (parsed.ingredients && Array.isArray(parsed.ingredients)) {
                        formattedContent += `
                            <div class="mb-6">
                                <h2 class="font-semibold text-bouton mb-4 text-xl flex items-center">
                                    <ion-icon name="basket-outline" class="mr-2"></ion-icon>
                                    ü•ò Ingr√©dients
                                </h2>
                                <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                                    <ul class="grid grid-cols-1 md:grid-cols-2 gap-2">
                                        ${parsed.ingredients.map(ingredient => `
                                            <li class="flex items-center">
                                                <ion-icon name="checkmark-circle-outline" class="text-green-600 mr-2 flex-shrink-0"></ion-icon>
                                                <span class="text-sm">${ingredient}</span>
                                            </li>
                                        `).join('')}
                                    </ul>
                                </div>
                            </div>
                        `;
                    }
                    
                    if (parsed.instructions && Array.isArray(parsed.instructions)) {
                        formattedContent += `
                            <div class="mb-6">
                                <h2 class="font-semibold text-bouton mb-4 text-xl flex items-center">
                                    <ion-icon name="list-outline" class="mr-2"></ion-icon>
                                    üë©‚Äçüç≥ Instructions
                                </h2>
                                <div class="space-y-4">
                                    ${parsed.instructions.map((instruction, index) => `
                                        <div class="bg-orange-50 border border-orange-200 rounded-lg p-4">
                                            <div class="flex items-start">
                                                <div class="bg-bouton text-white rounded-full w-8 h-8 flex items-center justify-center mr-3 flex-shrink-0 font-semibold">
                                                    ${index + 1}
                                                </div>
                                                <p class="text-sm leading-relaxed pt-1">${instruction}</p>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `;
                    }
                    
                    if (parsed.content && parsed.content !== recipeContent) {
                        formattedContent += `
                            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                                <h3 class="font-semibold text-yellow-800 mb-2">üí° Conseils suppl√©mentaires</h3>
                                <div class="text-sm text-yellow-700 leading-relaxed">${parsed.content}</div>
                            </div>
                        `;
                    }
                } else {
                    // Fallback to formatted text content
                    formattedContent = `<div class="whitespace-pre-wrap leading-relaxed">${recipeContent}</div>`;
                }
            } else {
                // Basic formatting for plain text
                formattedContent = `<div class="whitespace-pre-wrap leading-relaxed">${recipeContent}</div>`;
            }
            
            recipeContentDiv.innerHTML = formattedContent;
            
            // Show recipe display
            document.getElementById('loading-state').classList.add('hidden');
            document.getElementById('error-state').classList.add('hidden');
            recipeDisplay.classList.remove('hidden');
        }

        // Navigation and action functions
        function goBack() {
            if (document.referrer) {
                window.history.back();
            } else {
                window.location.href = './ia.html';
            }
        }

        function retryRecipe() {
            if (currentRecipeData.name) {
                generateRecipe(currentRecipeData.name, currentRecipeData.description);
            }
        }

        function generateNewRecipe() {
            if (currentRecipeData.name) {
                // Add variation context to generate a different version
                const variations = ['version traditionnelle', 'version moderne', 'version rapide', 'version festive'];
                const randomVariation = variations[Math.floor(Math.random() * variations.length)];
                
                currentRecipeData.description += ` (${randomVariation})`;
                generateRecipe(currentRecipeData.name, currentRecipeData.description);
            }
        }

        function saveRecipe() {
            if (currentRecipeData.content) {
                const blob = new Blob([`${currentRecipeData.name}\n\n${currentRecipeData.content}`], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${currentRecipeData.name.replace(/[^a-z0-9]/gi, '_')}_recipe.txt`;
                a.click();
                URL.revokeObjectURL(url);
            }
        }

        function shareRecipe() {
            if (currentRecipeData.content && navigator.share) {
                navigator.share({
                    title: `Recette: ${currentRecipeData.name}`,
                    text: currentRecipeData.content,
                    url: window.location.href
                });
            } else if (currentRecipeData.content) {
                // Fallback: copy to clipboard
                navigator.clipboard.writeText(`${currentRecipeData.name}\n\n${currentRecipeData.content}\n\nG√©n√©r√© par TchopIA - ${window.location.origin}`)
                    .then(() => alert('Recette copi√©e dans le presse-papiers!'))
                    .catch(err => console.error('Erreur lors de la copie:', err));
            }
        }

        function printRecipe() {
            window.print();
        }

        function setupMobileMenu() {
            const mobileMenuBtn = document.getElementById('mobile-menu-btn');
            const mobileMenu = document.getElementById('mobile-menu');
            
            if (mobileMenuBtn && mobileMenu) {
                mobileMenuBtn.addEventListener('click', function() {
                    if (mobileMenu.classList.contains('hidden')) {
                        mobileMenu.classList.remove('hidden');
                        mobileMenuBtn.querySelector('ion-icon').setAttribute('name', 'close');
                    } else {
                        mobileMenu.classList.add('hidden');
                        mobileMenuBtn.querySelector('ion-icon').setAttribute('name', 'menu');
                    }
                });
                
                // Hide menu when clicking outside
                document.addEventListener('click', function(event) {
                    if (!mobileMenu.contains(event.target) && !mobileMenuBtn.contains(event.target)) {
                        mobileMenu.classList.add('hidden');
                        mobileMenuBtn.querySelector('ion-icon').setAttribute('name', 'menu');
                    }
                });
            }
        }
    </script>
</body>

</html>